---
import BaseLayout from '../layouts/BaseLayout.astro';
import StatsCard from '../components/ui/StatsCard.astro';
import PostCard from '../components/community/PostCard.astro';
import NewPostForm from '@components/community/NewPostForm.astro';

const supabase = Astro.locals.supabase;

// Pega o usuário logado (do middleware)
const user = Astro.locals.user;

// Busca os posts reais do banco de dados
const { data: posts, error } = await supabase
  .from('posts')
  .select(`
    id,
    content,
    created_at,
    profiles (
      full_name,
      handle,
      avatar_url
    )
  `)
  .order('created_at', { ascending: false });

if (error) {
  console.error('Erro ao buscar posts:', error.message);
}

// (A lógica de Stats Card pode ser atualizada depois, por enquanto focamos no feed)
const totalMembros = 0; // TODO
const totalPosts = posts?.length || 0;
const totalOnline = 0; // TODO
---

<BaseLayout title="Alfa Community - Home" description="Bem-vindo à comunidade de desenvolvedores Alfa">
  <main class="min-h-screen bg-zinc-900">
    <div class="container mx-auto px-4 py-8">
      <header class="text-center mb-12">
        <h1 class="text-5xl font-bold text-white mb-4">Alfa Community</h1>
        <p class="text-xl text-zinc-300">Conectando desenvolvedores e compartilhando conhecimento</p>
      </header>

      <div class="max-w-4xl mx-auto">
        <!-- Seção Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
          <StatsCard value={totalMembros} label="Membros" />
          <StatsCard value={totalPosts} label="Posts" />
          <StatsCard value={totalOnline} label="Online" />
        </div>

        <NewPostForm class="mb-6" user={user} />

        <!-- Seção Feed -->
        <div class="space-y-4">
          <h3 class="text-xl font-semibold text-white mb-4">Posts Recentes</h3>
          <NewPostForm class="mb-6" user={user} />
          <div class="flex flex-col gap-4">
            {posts && posts.length > 0 ? (
              posts.map((post) => (
                <PostCard
                  postId={post.id}
                  authorName={post.profiles.full_name}
                  authorHandle={post.profiles.handle}
                  avatarUrl={post.profiles.avatar_url}
                  postContent={post.content}
                  likesCount={0}
                  commentsCount={0}
                  tags={[]}
                  isDetailPage={false}
                />
              ))
            ) : (
              <p class="text-zinc-400 text-center bg-zinc-800 p-6 rounded-lg">
                Nenhum post ainda. Seja o primeiro a publicar!
              </p>
            )}
          </div>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>
